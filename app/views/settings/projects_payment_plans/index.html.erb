<div>
  <div class="mt-1 mb-4 flex items-center w-full">
    <span class="w-1/3">
      <%= link_to dashboard_path, class: "inline-flex justify-between items-center p-2 text-xs border border-gray-200 rounded-lg bg-white hover:shadow-md transition-all" do %>
        <div class="flex items-center gap-1">
          <span class="text-gray-800"><%= render 'icons/back' %></span>
          <div class="flex flex-col">
            <span class="text-gray-500">Back</span>
          </div>
        </div>
      <% end %>
    </span>

    <span class="w-1/3 text-black text-base font-semibold flex justify-center">Payment Plans</span>
    <span class="w-1/3 flex justify-end">
      <%= render 'shared/breadcrumb', record_class: 'Payment Plans' %>
    </span>
  </div>
  
  <div class="flex gap-4">
    <div class="w-full border border-gray-200 rounded-lg bg-white/50 project-height-fix min-h-[calc(100vh-150px)]">
      <div class="">
        <div class="flex justify-between p-2 items-center flex-wrap gap-4">
          <%= form_with url: settings_projects_payment_plans_path, method: :get, class: "flex gap-2 flex-wrap items-center" do |form| %>
            <%= form.select :project_id, 
                  options_from_collection_for_select(@projects, :id, :name, params[:project_id]),
                  { include_blank: "All Projects" },
                  { class: "h-auto p-2.5 min-w-[200px] rounded border-gray-300", 
                    onchange: "this.form.submit();" } %>
            
            <%= form.text_field :search, 
                  value: params[:search],
                  placeholder: "Search by payment plan or project name...", 
                  class: "h-auto p-2.5 min-w-[400px] rounded border-gray-300" %>
            
            <%= form.button type: :submit, class: "bg-brand h-auto py-2 px-4 gap-2 hover:bg-brand/80 rounded text-white" do %>
              <%= render 'icons/searchsm' %>
            <% end %>
            
            <%= link_to settings_projects_payment_plans_path, class: "h-auto py-2 px-4 gap-2 rounded text-white flex items-center transition-colors #{(params[:search].present? || params[:project_id].present?) ? 'bg-gray-500 hover:bg-gray-600' : 'bg-gray-300 cursor-not-allowed'}" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span class="ml-1">Reset</span>
            <% end %>
          <% end %>
          
          <div class="ml-auto flex gap-2">
            <%= render_sheet direction: "right", width: "w-full sm:max-w-full lg:max-w-full md:w-2/3 lg:w-2/3 xl:w-2/3", class: "!slide-in-from-right bg-white/50 backdrop-blur-xl p-0" do %>
              <%= sheet_trigger do %>
                <%= render_button as: :link, href: "", class: "bg-brand/5 text-brand border border-gray-200 gap-2 hover:bg-brand hover:text-white" do %>
                  <%= render 'icons/add' %>
                  <span>Add Payment Plan</span>
                <% end %> 
              <% end %>

              <%= sheet_content do %>
                <%= render 'form', payment_plan: @payment_plans.new %>
              <% end %>
            <% end %>
          </div>
        </div>
        
        <div class="table-responsive">
          <%= render_table class: "overflow-hidden" do %>
            <%= table_head class: "rounded-t-md py-2 px-4 bg-gradient-to-bl from-[#ffe4e6] to-[#ccfbf1]" do %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Payment Plan Name</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Project</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Stages Count</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Total Percentage</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Total Amount</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Created At</span>
              <% end %>
              <%= table_header do %>
                <span class="text-gray-700 text-sm font-bold block">Action</span>
              <% end %>
            <% end %>
            
            <%= table_body do %>
              <% if @payment_plans.any? %>
                <% @payment_plans.each do |payment_plan| %>
                  <%= table_row do %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap font-medium text-brand">
                        <%= payment_plan.name %>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap">
                        <%= payment_plan.project.name if payment_plan.project %>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                          <%= pluralize(payment_plan.stages.count, 'stage') %>
                        </span>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap">
                        <% total_percentage = payment_plan.stages.sum(:percentage) %>
                        <% if total_percentage > 0 %>
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            <%= total_percentage == 100 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' %>">
                            <%= total_percentage %>%
                          </span>
                        <% else %>
                          <span class="text-gray-400 text-xs">N/A</span>
                        <% end %>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap">
                        <% total_amount = payment_plan.stages.sum(:amount) %>
                        <% if total_amount > 0 %>
                          <span class="font-medium text-gray-900">
                            â‚¹<%= number_with_delimiter(total_amount.to_i) %>
                          </span>
                        <% else %>
                          <span class="text-gray-400 text-xs">N/A</span>
                        <% end %>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap text-sm text-gray-500">
                        <%= payment_plan.created_at.strftime("%b %d, %Y") %>
                      </div>
                    <% end %>
                    <%= table_column do %>
                      <div class="whitespace-nowrap flex">
                        <%= render 'layouts/action_buttons', 
                          record: payment_plan, 
                          module_name: 'projects_payment_plan',
                          show_path: 'settings_projects_payment_plan',
                          edit_path: 'edit_settings_projects_payment_plan',
                          delete_path: 'settings_projects_payment_plan',
                          sheet: true
                        %>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>
              <% else %>
                <%= table_row do %>
                  <%= table_column colspan: 7, class: "text-center py-8 text-gray-500" do %>
                    <% if params[:search].present? || params[:project_id].present? %>
                      No payment plans found matching your criteria.
                    <% else %>
                      No payment plans found. Create your first payment plan to get started.
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </div>
        
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
          <% if @pagy.pages > 1 %>
            <%= render 'layouts/pagination', pagy: @pagy %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
